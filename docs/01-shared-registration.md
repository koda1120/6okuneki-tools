# 6億ニキ ツール群 共通ユーザー登録仕様

## 1. 概要

本ドキュメントは、6億ニキツール群で共通利用するユーザー登録画面の仕様を定義する。

### 1.1 目的

- **リスト構築**: 年齢・性別・メールアドレスの収集
- **規約同意**: 利用規約・免責事項への同意取得
- **ツール利用ゲート**: 未登録ユーザーはツール利用不可

### 1.2 共通パッケージの場所

```
packages/shared/src/components/registration/
├── RegistrationForm.tsx      # メインコンポーネント
├── AgeSelect.tsx             # 年齢選択
├── GenderSelect.tsx          # 性別選択
├── EmailInput.tsx            # メールアドレス入力
├── TermsCheckbox.tsx         # 同意チェックボックス
└── TermsScrollBox.tsx        # 規約表示エリア
```

---

## 2. 画面フロー

```
1. ユーザー登録画面（最初に必ず表示）
   ↓
2. フォーム入力 + 規約確認 + 同意チェック
   ↓
3. 「同意して始める」ボタンクリック
   ↓
4. スプレッドシートへデータ送信（バックグラウンド）
   ↓
5. 各ツールのメイン画面へ遷移
```

### 2.1 登録済みユーザーの判定

- **localStorage**で登録済みフラグを確認
- 登録済みならメイン画面へ直接遷移
- **ツールごとに異なるキー名を使用**

```typescript
// キー名の例
const STORAGE_KEY = `6okuniki_${toolId}_registered`;

// 携帯プラン: 6okuniki_mobile_registered
// クレカ: 6okuniki_credit_registered
// 不動産: 6okuniki_realtor_registered
```

---

## 3. コンポーネント仕様

### 3.1 RegistrationForm（メインコンポーネント）

```typescript
interface RegistrationFormProps {
  // 必須
  siteName: string;                    // GASに送信するツール識別名
  onComplete: (data: RegistrationData) => void;  // 完了時コールバック
  
  // カスタマイズ（オプション）
  title?: string;                      // 画面タイトル
  description?: string;                // 説明文
  accentColor?: string;                // アクセントカラー
  submitButtonText?: string;           // ボタンテキスト
  showGender?: boolean;                // 性別表示（デフォルト: true）
  localStorageKey?: string;            // カスタムキー（省略時は自動生成）
}
```

### 3.2 年齢選択（AgeSelect）

| 選択肢（表示） | 送信値 |
|--------------|--------|
| 10歳以下 | `0-10` |
| 11〜20歳 | `11-20` |
| 21〜30歳 | `21-30` |
| 31〜40歳 | `31-40` |
| 41〜50歳 | `41-50` |
| 51〜60歳 | `51-60` |
| 61〜70歳 | `61-70` |
| 70歳以上 | `70+` |

### 3.3 性別選択（GenderSelect）

| 選択肢（表示） | 送信値 |
|--------------|--------|
| 男性 | `male` |
| 女性 | `female` |
| その他 | `other` |
| 回答しない | `unknown` |

### 3.4 メールアドレス入力（EmailInput）

- **必須項目**
- RFC 5322準拠のバリデーション
- 最大254文字
- HTMLサニタイズ処理

---

## 4. 免責事項・利用規約

### 4.1 表示順序

1. **エンタメ免責**（最初に表示・固定表示）
2. **利用規約**（スクロールボックス内）

### 4.2 エンタメ免責（固定テキスト）

```
■ 免責事項
本ツールはエンターテインメント目的で提供しています。
表示される結果はあくまで参考情報であり、正確性・有用性について保証するものではありません。
本ツールの利用により生じた損害について、当方は一切の責任を負いかねます。
```

### 4.3 利用規約（スクロールボックス内）

高さ200px程度のスクロール可能なボックスに収める。

```
■ 利用規約

第1条（適用および定義）
当方が提供するメールマガジン配信サービス（以下「本サービス」といいます）の利用について、本利用規約（以下「本規約」といいます）を定めます。ユーザーは、本規約に同意の上で本サービスを利用するものとします。

本サービスとは、当方がウェブサイト上でユーザー登録を行った方に対し、電子メールで各種情報を提供するサービスを指します。
ユーザーとは、本サービスに必要な情報を当方ウェブサイト上の登録フォーム等に入力し、登録を完了した個人または法人を指します。
本規約に定めのない事項については、関連法令および当方が別途定める利用規約やポリシーの定めに従うものとします。

第2条（登録と利用開始）
本サービスの利用を希望する方は、当方所定の方法（ウェブ上の登録フォーム等）により、自らの意思でメールマガジンの登録手続きを行うものとします。登録希望者は正確かつ最新の情報（メールアドレス等）を入力し、本規約に同意の上で登録を申請するものとします。未成年の方が登録する場合は、事前に親権者等法定代理人の同意を得た上で登録してください。

当方は、所定の登録手続きを完了した申請者からの登録を承諾し、ユーザーとしてメールマガジンの配信を開始します。ただし、当方は、申請者が以下のいずれかに該当する場合、登録を承諾しないことがあります。
・登録申請内容に虚偽、誤記または記入漏れがあった場合
・過去に本サービスの利用規約違反等により登録抹消等の処分を受けていることが判明した場合
・その他、当方が登録を不適当と判断した場合

第3条（ユーザー情報の管理と個人情報の取り扱い）
ユーザーが登録したメールアドレスその他の個人情報は、当方の定めるプライバシーポリシーおよび関連法令に従い適切に取り扱い、厳重に管理します。当方は、ユーザーから事前の同意を得ることなく、登録された個人情報を本サービス提供目的以外に利用せず、また法令に基づく場合を除き第三者に提供しません。

当方は、ユーザーの承諾なしに登録情報の修正・変更を行いません。ユーザーは、登録内容（メールアドレス等）に変更が生じた場合、自身で登録情報の変更手続きを行うものとします。ただし、メールアドレスの変更についてはシステム上直接の変更ができないため、変更を希望する場合は一度登録解除（配信停止）を行った上で、新しいメールアドレスにて再度登録手続きを行ってください。

ユーザーが登録手続きの際にIDやパスワード等を設定した場合、その管理責任はユーザー本人が負うものとします。当方は、ユーザーのID・パスワードの不正利用等から生じた損害について、一切の責任を負いません。

第4条（メールマガジンの配信内容・頻度）
当方は、ユーザーに対し、メールマガジンとしてオールジャンルの各種情報を電子メールで配信します。配信されるメールには、当方または提携先の商品・サービスに関する情報、キャンペーンの案内、ニュースや記事、その他運営上必要な連絡事項などが含まれる場合があります。メールマガジンは原則無料で提供され、配信頻度や内容は当方の裁量で決定します。

ユーザーは、本サービスの配信停止を希望する場合、当方が指定する所定の方法（配信メール内の購読解除リンクのクリック、又は当方ウェブサイト上の解除フォーム送信等）により、いつでも登録を解除することができます。解除手続きが完了した後、当方は速やかに当該ユーザーへのメール配信を停止し、当方の保有データから当該ユーザーのメールアドレス等を削除します。ただし、システムの都合上、配信停止の反映に数日要する場合があり、その間にメールが送信されることがあります。

第5条（当方による登録解除・サービス提供の終了）
当方は、ユーザーが以下のいずれかに該当すると認めた場合、事前の通知や承諾を要せずに当該ユーザーの登録を解除し、本サービスの利用を停止することができます。当方はこの判断に関する理由を開示する義務を負いません。
・ユーザーが本規約のいずれかの条項に違反した場合
・登録されたメールアドレスが無効状態であると当方が判断した場合（長期間未使用である、メール配信が連続してエラーとなる等）
・他人になりすまして登録を行ったことが判明した場合
・不正に入手または自動生成された多数のメールアドレスを登録したと当方が判断した場合
・その他、ユーザーとして不適切な行為があった場合、またはユーザーとして継続することが不適当であると当方が判断した場合

当方は、ユーザーへの事前の通知なく、本サービスの全部または一部の提供を中止もしくは終了することができます。天災地変その他の不可抗力、システム保守や障害等により本サービスの提供が困難と当方が判断した場合、当方は一時的にサービス提供を停止することがあります。当方による本サービスの中止・終了に伴いユーザーに生じた損害について、当方は一切責任を負わないものとします。

第6条（禁止事項）
ユーザーは、本サービスの利用にあたり以下の行為を行ってはならないものとします。これらの禁止事項に違反した場合、当方は当該ユーザーへの本サービス提供を直ちに停止し、必要に応じて法的措置を講じる権利を有します。
・他人のメールアドレスを、その所有者の承諾なしに無断で本サービスに登録する行為
・虚偽の情報や他人の情報を用いて本サービスに登録する行為
・入手または生成した多数のメールアドレスを用い、意図的に大量の登録を行う行為
・当方または第三者の著作権・商標権等の知的財産権を侵害する行為、または侵害のおそれのある行為
・本サービスを通じて提供される内容を当方の承諾なく転載・転用・営利目的で利用する行為
・本サービスの運営を妨害する行為、当方のシステムに不正にアクセスしまたは過度な負担をかける行為
・法令または公序良俗に反する行為、その他当方が不適切と判断する行為

第7条（知的財産権）
本サービスにおいて当方が配信するメールマガジンの内容（文章、画像、映像、音声等すべてのコンテンツ）に関する著作権・商標権・その他の知的財産権および肖像権・パブリシティ権等は、当方または正当な権利者に帰属します。ユーザーは、当方および権利者の許可なく、本サービスで提供されるコンテンツを複製、転載、改変、頒布、公衆送信等の方法で利用してはなりません。万一ユーザーが本条に違反して第三者との間で問題が生じた場合、ユーザー自身の費用と責任においてその問題を解決するとともに、当方に一切の損害を与えないものとします。

第8条（免責事項）
当方は、本サービスにおいて提供する情報について、その正確性・有用性・最新性等に関していかなる保証も行いません。ユーザーは自己の判断と責任において本サービスの情報を利用するものとし、本サービスの利用または利用不能により生じた一切の損害について、当方は故意または重大な過失がない限り責任を負いません。

当方は、メールマガジンが確実に配信されること、および配信に遅延や不具合が生じないことを保証しません。本サービスの配信遅延・中断・停止、メールの不達・誤配等に起因してユーザーに生じた損害について、当方は一切の責任を負わないものとします。また、ユーザーが本サービスを利用するにあたり発生する通信費用等はユーザー負担とし、当方は負担いたしません。

ユーザーが本サービスを通じて取得した情報に基づき当方または第三者の商品・サービスを利用したことにより生じたトラブルや損害について、当方は一切責任を負いません（当方に故意または重大な過失がある場合を除きます）。

本規約に別途定める場合のほか、当方は本サービスに関連してユーザーに生じた一切の損害について、法律上許容される最大限の範囲で責任を免れるものとします。

第9条（規約の変更）
当方は、必要に応じて本規約を変更することができます。規約を変更する場合、変更後の規約の施行日までに当方ウェブサイト上への掲示や電子メール等の適切な方法で周知し、施行日以降は変更後の規約を本サービスに適用します。ユーザーが規約変更後も本サービスの利用を継続した場合、変更後の規約に同意したものとみなします。なお、本規約の変更によりユーザーに生じた不利益・損害について、当方は一切責任を負いません。

第10条（準拠法および合意管轄）
本規約の成立、履行、解釈にあたっては日本法が適用されます。本サービスに関連して当方とユーザーとの間で生じた紛争については、当方の所在地を管轄する裁判所を第一審の専属的合意管轄裁判所とします。
```

### 4.4 同意チェックボックス

```
☐ 上記の免責事項および利用規約に同意します
```

- **必須チェック**
- 未チェック時はボタン無効化

---

## 5. スプレッドシート連携

### 5.1 GAS URL

```
https://script.google.com/macros/s/AKfycbxpH8mJWk57MDoO5Q0rUdGzQ2GytKhKqjNm1i35j_sQaAFkky6Toi9WmQhG1DcIxWFmVA/exec
```

### 5.2 送信データ形式

| フィールド | 値 |
|------------|-----|
| `age` | 年齢範囲（`0-10`, `11-20`, `21-30`, `31-40`, `41-50`, `51-60`, `61-70`, `70+`） |
| `gender` | 性別（`male`, `female`, `other`, `unknown`） |
| `email` | メールアドレス |
| `siteName` | ツール名（**各ツールで固定値を設定**） |

**注意**: `registeredAt`（タイムスタンプ）はGAS側で記録するため、フロントからは送信不要。

### 5.3 siteName一覧

| ツール | siteName |
|--------|----------|
| 携帯プラン最適化 | `携帯料金プラン最適化診断` |
| クレカ明細チェッカー | `生活コスト見直し診断 クレカ明細チェッカー` |
| 不動産仲介手数料 | `不動産仲介手数料適性チェック` |

### 5.4 送信コード

```typescript
// packages/shared/src/lib/api.ts

const GAS_URL = 'https://script.google.com/macros/s/AKfycbxpH8mJWk57MDoO5Q0rUdGzQ2GytKhKqjNm1i35j_sQaAFkky6Toi9WmQhG1DcIxWFmVA/exec';

interface RegistrationPayload {
  age: string;
  gender: string;
  email: string;
  siteName: string;
}

export async function sendRegistration(data: RegistrationPayload): Promise<boolean> {
  try {
    await fetch(GAS_URL, {
      method: 'POST',
      body: JSON.stringify(data)  // JSON形式で送信
    });
    return true;
  } catch (error) {
    // エラー時もツール利用は継続可能
    console.error('Registration data send failed (non-blocking)');
    return false;
  }
}
```

**重要**:
- `Content-Type`ヘッダーや`no-cors`モードは不要
- 必ず`JSON.stringify(data)`を使用
- エラー時もツール利用は継続可能にする

### 5.5 GAS側コード（参考・変更厳禁）

```javascript
function doPost(e) {
  try {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
    const data = JSON.parse(e.postData.contents);

    // GAS returns JST by default
    const now = new Date();

    sheet.appendRow([
      now,
      data.age || '',
      data.gender || '',
      data.email || '',
      data.siteName || '不明'
    ]);

    return ContentService.createTextOutput(JSON.stringify({
      result: 'success',
      message: 'Data saved'
    })).setMimeType(ContentService.MimeType.JSON);

  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({
      result: 'error',
      message: error.toString()
    })).setMimeType(ContentService.MimeType.JSON);
  }
}
```

**警告**: このGASは全ツール共通で使用。変更は慎重に行うこと。

---

## 6. デザイン仕様

### 6.1 レイアウト

- **1画面収まり**: トップページ全体が1画面（スクロールなし）で収まる
- **利用規約のみスクロール**: 高さ200px程度のスクロールボックス
- **中央配置**: フォームと同意チェックボックスはページ中央

### 6.2 スクロールボックスCSS例

```css
.terms-scroll-box {
  height: 200px;
  overflow-y: auto;
  border: 1px solid #ccc;
  padding: 15px;
  background-color: #f9f9f9;
  font-size: 12px;
  line-height: 1.6;
  border-radius: 4px;
}
```

### 6.3 ボタン

- **テキスト**: 「同意して始める」（カスタマイズ可能）
- **中央配置**
- **同意チェック未チェック時**: `disabled`状態

---

## 7. セキュリティ要件

### 7.1 入力バリデーション

```typescript
// packages/shared/src/lib/validation.ts

export function validateEmail(email: string): boolean {
  const pattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return pattern.test(email) && email.length <= 254;
}

export function sanitize(input: string): string {
  return input
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#x27;');
}
```

### 7.2 その他のセキュリティ対策

- XSS対策: `innerHTML`の使用を避け、`textContent`を使用
- 入力長の制限
- エラーメッセージに内部情報を含めない
- `console.log`にセンシティブな情報を出力しない

---

## 8. 型定義

```typescript
// packages/shared/src/types/registration.ts

export type AgeRange = 
  | '0-10' | '11-20' | '21-30' | '31-40' 
  | '41-50' | '51-60' | '61-70' | '70+';

export type Gender = 'male' | 'female' | 'other' | 'unknown';

export interface RegistrationData {
  age: AgeRange;
  gender: Gender;
  email: string;
  siteName: string;
}

export interface RegistrationFormProps {
  siteName: string;
  onComplete: (data: RegistrationData) => void;
  title?: string;
  description?: string;
  accentColor?: string;
  submitButtonText?: string;
  showGender?: boolean;
  localStorageKey?: string;
}
```

---

## 9. 実装チェックリスト

実装時に必ず確認すること：

- [ ] `siteName`が正しく設定されているか
- [ ] GAS URLへのPOST送信が実装されているか
- [ ] エラー時もツール利用が継続可能か
- [ ] localStorageのキー名がツールごとに異なるか
- [ ] 入力バリデーション（メールアドレス形式）が実装されているか
- [ ] HTMLサニタイズが実装されているか
- [ ] 同意チェックなしでボタンが無効化されているか

---

## 10. 実装時の注意事項（Claude向け）

### 10.1 必須確認事項

**重要**: ユーザー登録画面を実装する際は、必ず最初にユーザーに以下を確認すること：

1. **ツール名** - `siteName`フィールドに設定する値

ユーザーがツール名を伝えずに実装を依頼してきた場合は、実装を始める前に必ず聞き返すこと。

### 10.2 複数ファイルの取り扱い

このユーザー登録画面の要件定義は、各ツール固有の要件定義書と組み合わせて使用する。

**重要**: 2つのファイルの内容が矛盾・衝突する場合は、勝手に判断せず必ずユーザーに確認してから進めること。

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2025-01-16 | モノレポ構成として初版作成 |
